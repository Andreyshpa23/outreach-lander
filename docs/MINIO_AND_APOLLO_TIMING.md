# Когда пишем в MinIO и как быстро отвечает Apollo

## В какой момент сохраняем в MinIO

### 1. POST /api/demo-import

**Момент:** сразу внутри одного HTTP-запроса.

- Клиент шлёт JSON (product + segments).
- Сервер валидирует payload → один раз вызывает `uploadDemoImportToS3(payload)` → файл попадает в бакет: **demo-imports/{uuid}.json**.
- Ответ клиенту отдаётся только после успешной записи в MinIO.

Итого: **одна запись в MinIO за один запрос**, синхронно, до ответа пользователю.

---

### 2. Leadgen (воркер после POST /api/leadgen)

**Момент:** один раз в конце воркера, после того как Apollo уже отдал все страницы и мы набрали лидов.

Последовательность воркера:

1. Статус job → `running`.
2. Цикл по шагам widening (strict → medium → loose) и по страницам Apollo, пока не набрали `target_leads` или не истекло `max_runtime_ms` (по умолчанию 45 сек). **В MinIO в этот момент ничего не пишем.**
3. Когда цикл завершён, формируем `finalLeads` и `linkedin_urls`.
4. **Только тогда:**
   - если есть лиды и настроен storage → **uploadCsv** → файл в **leadgen-csv/{jobId}.csv**, затем presigned URL в результат job;
   - если есть `linkedin_urls` и при создании job был передан `minio_payload` (product + segments) → **uploadDemoImportToS3** → файл в **demo-imports/{uuid}.json**.

Итого: при leadgen в MinIO пишем **один раз в конце** (CSV всегда при наличии лидов; JSON — только если передан `minio_payload`). Во время опроса Apollo записей в MinIO нет.

---

## Как быстро отвечает Apollo

- **Один запрос:** `POST https://api.apollo.io/api/v1/mixed_people/api_search`, у нас по 100 человек на страницу (`per_page=100`).
- **Обычно:** ответ приходит за **сотни миллисекунд – 1–3 секунды** в зависимости от нагрузки Apollo и объёма выборки.
- **Ретраи:** при 429 или 5xx делаем до 3 попыток с экспоненциальным backoff (1s, 2s, 4s). Между успешными страницами дополнительных задержек нет — сразу запрашиваем следующую.
- **Сколько запросов:** при `target_leads=100` и 100 лидов на страницу — минимум 1 запрос к Apollo; при нескольких шагах widening и большом target — несколько запросов (несколько страниц × несколько шагов).

**Практически:** первый ответ от Apollo обычно приходит быстро (< 2 сек); полный набор, например, 100 лидов может занять от нескольких секунд до десятков секунд (если много шагов widening и страниц). Запись в MinIO происходит уже после этого, в конце воркера.
